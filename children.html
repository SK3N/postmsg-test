<!DOCTYPE html>
<html lang="ja">

  <head>
    <meta charset="UTF-8" />
    <title>Child - postMessageテスト</title>
    <style>
      body {
        font-family: sans-serif;
        padding: 2rem;
      }

      input {
        width: 100%;
        padding: 0.5rem;
        margin-top: 1rem;
      }
    </style>
  </head>

  <body>
    <h1>Child Frame</h1>
    <p>ここは iframe 内です</p>

    <label for="tracking">トラッキングコード：</label>
    <input type="text" id="tracking" name="tracking" placeholder="未入力" />

    <script>
      (function () {
        // クエリパラメータ + リファラをまとめて取得
        function getTrackingData() {
          const data = {};
          const urlParams = new URLSearchParams(window.location.search);
          for (const [key, value] of urlParams.entries()) {
            data[key] = value;
          }

          const ref = document.referrer;
          if (ref.includes("google.") || ref.includes("search.yahoo.")) {
            data['organic_source'] = ref;
          } else if (ref) {
            data['referrer'] = ref;
          }

          return data;
        }

        // iframe 子ページ（message受信）
        window.addEventListener('message', function (event) {
          // 必要に応じてオリジンチェック
          if (!event.origin.includes('sk3n.github.io') && !event.origin.includes('shaftkk.net')) return;

          const data = event.data;
          const input = document.getElementById("tracking");

          if (input) {
            // iframe子ページ用
            if (data.organic_source) {
              input.value = "オーガニック検索: " + data.organic_source;
            } else if (data.referrer) {
              input.value = "参照元: " + data.referrer;
            } else if (data.gclid || data.gbraid || data.gad_source || data.gad_campaignid) {
              input.value =
                data.gclid ? "gclid: " + data.gclid :
                  data.gbraid ? "gbraid: " + data.gbraid :
                    data.gad_source ? "gad_source: " + data.gad_source :
                      "gad_campaignid: " + data.gad_campaignid;
            } else {
              input.value = "受信データ: " + JSON.stringify(data);
            }
          }

          // hidden input がある場合も対応（共通名: tracking_code）
          const hidden = document.querySelector('input[type="hidden"][name="tracking_code"]');
          if (hidden) {
            if (data.organic_source) {
              hidden.value = "organic: " + data.organic_source;
            } else if (data.referrer) {
              hidden.value = "referrer: " + data.referrer;
            } else if (data.gclid || data.gbraid || data.gad_source || data.gad_campaignid) {
              hidden.value =
                data.gclid ? "gclid: " + data.gclid :
                  data.gbraid ? "gbraid: " + data.gbraid :
                    data.gad_source ? "gad_source: " + data.gad_source :
                      "gad_campaignid: " + data.gad_campaignid;
            } else {
              hidden.value = "raw: " + JSON.stringify(data);
            }
          }
        });

        // iframe親ページ → 子ページへ postMessage
        window.addEventListener('DOMContentLoaded', function () {
          const iframe = document.getElementById("child-iframe");
          if (iframe && iframe.contentWindow) {
            const data = getTrackingData();
            setTimeout(() => {
              iframe.contentWindow.postMessage(data, '*');
            }, 100); // onload対策
          }

          // iframe でない場合でも、tracking_code hiddenがあれば代入
          const hidden = document.querySelector('input[type="hidden"][name="tracking_code"]');
          if (hidden) {
            const data = getTrackingData();
            if (data.organic_source) {
              hidden.value = "organic: " + data.organic_source;
            } else if (data.referrer) {
              hidden.value = "referrer: " + data.referrer;
            } else if (data.gclid || data.gbraid || data.gad_source || data.gad_campaignid) {
              hidden.value =
                data.gclid ? "gclid: " + data.gclid :
                  data.gbraid ? "gbraid: " + data.gbraid :
                    data.gad_source ? "gad_source: " + data.gad_source :
                      "gad_campaignid: " + data.gad_campaignid;
            } else {
              hidden.value = "raw: " + JSON.stringify(data);
            }
          }
        });
      })();
    </script>
  </body>

</html>