<!DOCTYPE html>
<html lang="ja">

  <head>
    <meta charset="UTF-8">
    <title>親ページ</title>
    <style>
      .parent {
        max-width: 768px;
        margin: 2rem auto;
      }
    </style>
  </head>

  <body>
    <div class="parent">
      <h1>親ページ</h1>

      <iframe id="child-iframe" src="https://shaftkk.net/children.html" width="100%" height="600" style="border:1px solid #ccc;"></iframe>

      <script>
        function getQueryParams() {
          const params = {};
          const searchParams = new URLSearchParams(window.location.search);
          for (const [key, value] of searchParams.entries()) {
            params[key] = value;
          }

          // オーガニック検索判定（referrerベース）
          const ref = document.referrer;
          if (ref.includes("google.") || ref.includes("search.yahoo.")) {
            params['organic_source'] = ref;
          }

          return params;
        }

        // ページ読み込み完了後にiframeへpostMessage送信
        window.addEventListener('load', () => {
          const iframe = document.getElementById("child-iframe");

          if (!iframe) return;

          // すでに読み込み済みでも onload が発火しないことがあるため、setTimeoutで念のため遅延も可
          iframe.onload = () => {
            const trackingData = getQueryParams();
            console.log("送信内容：", trackingData);
            iframe.contentWindow.postMessage(trackingData, 'https://potsmsg-test.netlify.app');
          };
        });
      </script>
    </div>
  </body>

</html>