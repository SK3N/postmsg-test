<!DOCTYPE html>
<html lang="ja">

  <head>
    <meta charset="UTF-8">
    <title>親ページ</title>
    <style>
      .parent {
        max-width: 768px;
        margin: 2rem auto;
      }
    </style>
  </head>

  <body>
    <div class="parent">
      <h1>親ページ</h1>

      <iframe id="child-iframe" src="https://potsmsg-test.netlify.app/children.html" width="100%" height="600" style="border:1px solid #ccc;"></iframe>

      <script>
        (function () {
          /** ▼設定項目：環境に合わせて編集してください ▼ **/

          // 1. 親ページのオリジン（https://〜で始まるドメイン）※厳密に指定
          const TRUSTED_ORIGINS = [
            "https://your-parent-domain.com",  // ← 本番用など必要に応じて追加
            "https://sk3n.github.io",          // ← テスト用
            "https://shaftkk.net"              // ← テスト用
          ];

          // 2. Pardotで作成した「トラッキング項目」の name 属性（例：自動生成されるもの）
          const TRACKING_FIELD_NAME = "1031841_145641pi_1031841_145641";

          /** ▲ここまで設定変更 ▲ **/

          // クエリパラメータ + リファラ取得
          function getTrackingData() {
            const data = {};
            const params = new URLSearchParams(window.location.search);
            for (const [key, value] of params.entries()) {
              data[key] = value;
            }
            const ref = document.referrer;
            if (ref.includes("google.") || ref.includes("search.yahoo.")) {
              data.organic_source = ref;
            } else if (ref) {
              data.referrer = ref;
            }
            return data;
          }

          // iframe 子ページ：postMessageを受け取る処理
          window.addEventListener('message', function (event) {
            if (!TRUSTED_ORIGINS.includes(event.origin)) return;

            const data = event.data;
            const input = document.getElementById("tracking");
            if (input) {
              input.value =
                data.organic_source ? "オーガニック検索: " + data.organic_source :
                  data.referrer ? "参照元: " + data.referrer :
                    data.gclid ? "gclid: " + data.gclid :
                      data.gbraid ? "gbraid: " + data.gbraid :
                        data.gad_source ? "gad_source: " + data.gad_source :
                          data.gad_campaignid ? "gad_campaignid: " + data.gad_campaignid :
                            "受信データ: " + JSON.stringify(data);
            }

            const hidden = document.querySelector(`input[name="${TRACKING_FIELD_NAME}"]`);
            if (hidden) {
              hidden.value =
                data.organic_source ? "organic: " + data.organic_source :
                  data.referrer ? "referrer: " + data.referrer :
                    data.gclid ? "gclid: " + data.gclid :
                      data.gbraid ? "gbraid: " + data.gbraid :
                        data.gad_source ? "gad_source: " + data.gad_source :
                          data.gad_campaignid ? "gad_campaignid: " + data.gad_campaignid :
                            "raw: " + JSON.stringify(data);
            }
          });

          // DOM構築後：親→子へ postMessage送信 + hiddenへの直接代入（非iframe時）
          window.addEventListener('DOMContentLoaded', function () {
            const data = getTrackingData();

            // iframeがあれば送信
            const iframe = document.getElementById("child-iframe");
            if (iframe && iframe.contentWindow) {
              iframe.onload = () => {
                iframe.contentWindow.postMessage(data, '*');
              };
              // 念のため遅延でもう一度送信
              setTimeout(() => {
                iframe.contentWindow.postMessage(data, '*');
              }, 800);
            }

            // iframeでない場合も hidden フィールドに代入
            const hidden = document.querySelector(`input[name="${TRACKING_FIELD_NAME}"]`);
            if (hidden) {
              hidden.value =
                data.organic_source ? "organic: " + data.organic_source :
                  data.referrer ? "referrer: " + data.referrer :
                    data.gclid ? "gclid: " + data.gclid :
                      data.gbraid ? "gbraid: " + data.gbraid :
                        data.gad_source ? "gad_source: " + data.gad_source :
                          data.gad_campaignid ? "gad_campaignid: " + data.gad_campaignid :
                            "raw: " + JSON.stringify(data);
            }
          });
        })();
      </script>
    </div>
  </body>

</html>